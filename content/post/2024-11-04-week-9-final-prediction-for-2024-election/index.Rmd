---
title: 'Week 9: Final Prediction for 2024 Election'
author: John Kulow
date: '2024-11-04'
slug: week-9-final-prediction-for-2024-election
categories: []
tags: []
---


```{r setup, warning = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, messages = FALSE, warning = FALSE)
```

```{r libraries, include=FALSE}
library(blogdown)
library(car)
library(caret)
library(curl)
library(CVXR)
library(foreign)
library(geofacet)
library(ggpubr)
library(ggthemes)
library(glmnet)
library(gridExtra)
library(haven)
library(janitor)
library(kableExtra)
library(knitr)
library(maps)
library(mgcv)
library(mgcViz)
library(mlr3)
library(patchwork)
library(randomForest)
library(ranger)
library(RColorBrewer)
library(readxl)
library(rstan)
library(scales)
library(sf)
library(shinystan)
library(sjPlot)
library(spData)
library(stargazer)
library(tidygeocoder)
library(tidyverse)
library(tigris)
library(tmap)
library(tmaptools)
library(viridis)
```

```{r importing data, include=FALSE}
####----------------------------------------------------------#
#### Read, merge, and process data.
####----------------------------------------------------------#

# Read popular vote datasets. 
d_popvote <- read_csv("data/popvote_1948_2020.csv")
d_state_popvote <- read_csv("data/state_popvote_1948_2020.csv")
d_state_popvote[d_state_popvote$state == "District of Columbia",]$state <- "District Of Columbia"

# Read elector distribution dataset. 
d_ec <- read_csv("data/corrected_ec_1948_2024.csv")

# Read polling data. 
d_polls <- read_csv("data/national_polls_1968-2024.csv")
d_state_polls <- read_csv("data/state_polls_1968-2024.csv")

# Read turnout data. 
d_turnout <- read_csv("data/state_turnout_1980_2022.csv")

# Read county turnout. 
d_county_turnout <- read_csv("data/county_turnout.csv")

# Read state-level demographics.
d_state_demog <- read_csv("data/demographics.csv")

# Read county demographics. 
d_county_demog <- read_csv("data/county_demographics.csv")

# Read campaign events datasets. 
d_campaign_events <- read_csv("data/campaigns_2016_2024.csv")[,-1]

d_pollav_nat <- read_csv("data/national_polls_1968-2024.csv")
d_pollav_state <- read_csv("data/state_polls_1968-2024.csv")
```

```{r nat model, include=FALSE}
d_poll_nat <- d_pollav_nat |>
  select(year, state, weeks_left, poll_date, poll_support, party) |>
  filter(month(poll_date) %in% c(9, 10)) |>
  group_by(year, party, month = month(poll_date)) |>
  summarize(poll_support = round(weighted.mean(poll_support, weeks_left, na.rm = TRUE), 2), .groups = "drop") |>
  pivot_wider(names_from = month, 
              values_from = poll_support, 
              names_prefix = "month_") |>
  drop_na() |>
  rename(sept_poll = month_9, 
         oct_poll = month_10)

d_fred <- read_csv("data/fred_econ.csv")

d_fred_2 <- d_fred |>
  filter(quarter == 2)

d_nat_model <- d_popvote |> 
  mutate(party = if_else(party == "democrat", "DEM", "REP")) |>
  left_join(d_fred_2, by = "year") |> 
  filter(year > 1967, 
         year != 2020,
         incumbent_party) |>
  mutate(incumbent = as.numeric(incumbent)) |>
  left_join(d_poll_nat, by = c("year", "party"))

d_nat_reg <- lm(pv2p ~ sept_poll + oct_poll + GDP_growth_quarterly + incumbent, 
                data = d_nat_model)
```

```{r nat model table}
tab_model(d_nat_reg, show.se = TRUE, 
          title = "National Model Regression Table", 
          dv.labels = "National 2-Party Vote Share for Incumbent Party")
```

```{r nat model validation, include=FALSE}
set.seed(02138)

out_samp_errors <- sapply(1:1000, function(i) {
  years_out_samp <- sample(d_nat_model$year, 6)
  mod <- lm(pv2p ~ sept_poll + oct_poll + GDP_growth_quarterly + incumbent, 
            data = d_nat_model[!(d_nat_model$year %in% years_out_samp),])
  out_samp_pred <- predict(mod, d_nat_model[d_nat_model$year %in% years_out_samp,])
  if (any(is.na(out_samp_pred)) || any(is.na(d_nat_model$pv2p[d_nat_model$year %in% years_out_samp]))) {
    return(NA)
  }
  out_samp_truth <- d_nat_model$pv2p[d_nat_model$year %in% years_out_samp]
  mean(abs(out_samp_pred - out_samp_truth))
})
out_samp_errors <- na.omit(out_samp_errors)
mean_out_samp_error <- mean(abs(out_samp_errors))

nat_model_valid_plot <- ggplot() +
  geom_histogram(aes(x = out_samp_errors), fill = "lightgray", binwidth = 0.5) + 
  geom_vline(aes(xintercept = mean_out_samp_error), color = "black") +
  labs(title = "Out-of-Sample Cross-Validation Errors",
       x = "Mean Absolute Errors",
       y = "") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  )
```

```{r nat model validation graph}
nat_model_valid_plot
```

```{r nat pred, include=FALSE}
d_nat_model_2024 <- d_nat_model |>
  filter(year == 2024) |>
  select(sept_poll, oct_poll, GDP_growth_quarterly, juneapp) |>
  mutate(incumbent = 0)

nat_pred_2024 <- predict(d_nat_reg, d_nat_model_2024, interval = "prediction")
```

```{r nat pred graphic 1}
knitr::kable(nat_pred_2024, 
             col.names = c("Harris Vote Share", "Lower Bound", "Upper Bound")) 
```

** INSERT PRETTIER GRAPHIC **




```{r state model, include=FALSE}
nat_poll_d_yearly <- d_pollav_nat |>
  select(year, state, weeks_left, poll_date, poll_support, party) |>
  filter(month(poll_date) %in% c(9, 10)) |>
  group_by(year, party, month = month(poll_date)) |>
  summarize(poll_support = round(weighted.mean(poll_support, weeks_left, na.rm = TRUE), 2), .groups = "drop") |>
  pivot_wider(names_from = month, 
              values_from = poll_support, 
              names_prefix = "month_") |>
  drop_na() |>
  rename(nat_sept_poll = month_9, 
         nat_oct_poll = month_10) |>
  filter(party == "DEM")

d_poll_state <- d_pollav_state |>
  select(year, state, weeks_left, poll_date, poll_support, party) |>
  filter(month(poll_date) %in% c(9, 10),
         party == "DEM", 
         year > 1999) |>
  group_by(year, state, month = month(poll_date)) |>
  summarize(poll_support = round(weighted.mean(poll_support, weeks_left, na.rm = TRUE), 2), .groups = "drop") |>
  pivot_wider(names_from = month, 
              values_from = poll_support, 
              names_prefix = "month_") |>
  left_join(d_state_popvote, by = c("year", "state")) |>
  select(year, state, month_9, month_10, D_pv2p, D_pv2p_lag1, D_pv2p_lag2) |>
  drop_na() |>
  rename(sept_poll = month_9, 
         oct_poll = month_10) |>
  left_join(d_fred_2, by = "year") |>
  mutate(d_incumbent = case_when(year == "2000" ~ 1,
                                 year == "2004" ~ 0,
                                 year == "2008" ~ 0,
                                 year == "2012" ~ 1,
                                 year == "2016" ~ 1,
                                 year == "2020" ~ 0,
                                 year == "2024" ~ 1),
         D_pv2p_lag_shift = D_pv2p_lag1 - D_pv2p_lag2) |>
  left_join(nat_poll_d_yearly, by = "year")

d_state_reg <- lm(D_pv2p ~ sept_poll + oct_poll + D_pv2p_lag1 + D_pv2p_lag2 + d_incumbent + nat_oct_poll, 
                data = d_poll_state)
```

```{r state model reg}
tab_model(d_state_reg, show.se = TRUE, 
          title = "State Model Regression Table", 
          dv.labels = "State 2-Party Vote Share for Democrats")
```


```{r state model validation, include=FALSE}
set.seed(02138)

out_samp_errors_st <- sapply(1:1000, function(i) {
  years_out_samp_st <- sample(d_poll_state$year, 3)
  mod_st <- lm(D_pv2p ~ sept_poll + oct_poll + D_pv2p_lag1 + D_pv2p_lag2 + d_incumbent + nat_oct_poll, 
            data = d_poll_state[!(d_poll_state$year %in% years_out_samp_st),])
  out_samp_pred_st <- predict(mod_st, d_poll_state[d_poll_state$year %in% years_out_samp_st,])
  if (any(is.na(out_samp_pred_st)) || any(is.na(d_poll_state$D_pv2p[d_poll_state$year %in% years_out_samp_st]))) {
    return(NA)
  }
  out_samp_truth_st <- d_poll_state$D_pv2p[d_poll_state$year %in% years_out_samp_st]
  mean(abs(out_samp_pred_st - out_samp_truth_st))
})
out_samp_errors_st <- na.omit(out_samp_errors_st)
mean_out_samp_error_st <- mean(abs(out_samp_errors_st))

state_model_valid_plot <- ggplot() +
  geom_histogram(aes(x = out_samp_errors_st), fill = "lightgray", binwidth = 0.25) + 
  geom_vline(aes(xintercept = mean_out_samp_error_st), color = "black") +
  labs(title = "Out-of-Sample Cross-Validation Errors",
       x = "Mean Absolute Errors",
       y = "") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
  )
```

```{r state validation graph}
state_model_valid_plot
```

```{r state pred, include=FALSE}
d_state_model_2024 <- d_pollav_state |>
  select(year, state, weeks_left, poll_date, poll_support, party) |>
  filter(month(poll_date) %in% c(9, 10),
         party == "DEM") |>
  group_by(year, state, month = month(poll_date)) |>
  summarize(poll_support = round(weighted.mean(poll_support, weeks_left, na.rm = TRUE), 2), .groups = "drop") |>
  pivot_wider(names_from = month, 
              values_from = poll_support, 
              names_prefix = "month_") |>
  left_join(d_state_popvote, by = c("year", "state")) |>
  arrange(state, year) |>
  group_by(state) |>
  mutate(D_pv2p_lag1 = lag(D_pv2p, n = 1),
         D_pv2p_lag2 = lag(D_pv2p, n = 2)) |>
  ungroup() |>
  select(year, state, month_9, month_10, D_pv2p, D_pv2p_lag1, D_pv2p_lag2) |>
  rename(sept_poll = month_9, 
         oct_poll = month_10) |>
  left_join(d_fred_2, by = "year") |>
  mutate(d_incumbent = case_when(year == "2008" ~ 0,
                                 year == "2012" ~ 1,
                                 year == "2016" ~ 1,
                                 year == "2020" ~ 0,
                                 year == "2024" ~ 1)) |>
  filter(year == "2024") |>
  mutate(sept_poll = case_when(is.na(sept_poll) == 1 ~ oct_poll,
                               TRUE ~ sept_poll),
         D_pv2p_lag1 = case_when(state == "Nebraska Cd 2" ~ 53.27,
                                 state == "Maine Cd 2" ~ 46.86,
                                 TRUE ~ D_pv2p_lag1),
         D_pv2p_lag2 = case_when(state == "Nebraska Cd 2" ~ 48.99,
                                 state == "Maine Cd 2" ~ 45.12,
                                 TRUE ~ D_pv2p_lag2)) |>
  left_join(nat_poll_d_yearly, by = "year")

state_pred_2024 <- predict(d_state_reg, d_state_model_2024, interval = "prediction")

d_state_model_2024 <- d_state_model_2024 |>
  mutate(predicted_values = state_pred_2024[, "fit"],
         lower_bounds = state_pred_2024[, "lwr"],
         upper_bounds = state_pred_2024[, "upr"])
```

```{r state pred graphic}
knitr::kable(d_state_model_2024 |> 
               select(state, predicted_values, lower_bounds, upper_bounds), 
             col.names = c("State", "Harris Vote Share", "Lower Bound", "Upper Bound")) |>
  row_spec(which(d_state_model_2024$predicted_values >= 50), background = "#D0EFFF") |>
  row_spec(which(d_state_model_2024$predicted_values < 50), background = "#FFDDDD")   

```


```{r state model 2, include=FALSE}
d_nopoll_states <- d_state_popvote |>
  select(year, state, D_pv2p, D_pv2p_lag1, D_pv2p_lag2) |>
  left_join(d_fred_2, by = "year") |>
  mutate(d_incumbent = case_when(year == "1948" ~ 1,
                                 year == "1952" ~ 1,
                                 year == "1956" ~ 0,
                                 year == "1960" ~ 0,
                                 year == "1964" ~ 1,
                                 year == "1968" ~ 1,
                                 year == "1972" ~ 0,
                                 year == "1976" ~ 0,
                                 year == "1980" ~ 1,
                                 year == "1984" ~ 0,
                                 year == "1988" ~ 0,
                                 year == "1992" ~ 0,
                                 year == "1996" ~ 1,
                                 year == "2000" ~ 1,
                                 year == "2004" ~ 0,
                                 year == "2008" ~ 0,
                                 year == "2012" ~ 1,
                                 year == "2016" ~ 1,
                                 year == "2020" ~ 0,
                                 year == "2024" ~ 1)) |>
  filter(year > 2000) |>
  left_join(nat_poll_d_yearly, by = "year")

d_nopoll_state_reg <- lm(D_pv2p ~ D_pv2p_lag1 + D_pv2p_lag2 + d_incumbent + nat_sept_poll + nat_oct_poll,
                data = d_nopoll_states)
```

```{r state model 2 reg}
tab_model(d_nopoll_state_reg, show.se = TRUE, 
          title = "State Model (Without Polls) Regression Table", 
          dv.labels = "State 2-Party Vote Share for Democrats")
```

```{r combined state pred and graphic setup, include=FALSE}
states <- unique(d_state_popvote$state)  # List of all 50 states
year_2024 <- 2024
new_rows <- expand.grid(year = year_2024, state = states)

# Join with historical data to get D_pv2p_lag1 and D_pv2p_lag2
new_rows <- new_rows |>
  left_join(d_state_popvote |>
              filter(year %in% c(2020, 2016)) |>
              select(state, year, D_pv2p) |>
              arrange(state, year) |>
              group_by(state) |>
              summarize(
                D_pv2p_lag1 = D_pv2p[year == 2020],  # Lag 1 from 2020
                D_pv2p_lag2 = D_pv2p[year == 2016]   # Lag 2 from 2016
              ),
            by = "state")

# Add new rows to the original dataset
d_state_popvote_2024 <- bind_rows(d_state_popvote, new_rows)

d_nopoll_state_model_2024 <- d_state_popvote_2024 |>
  select(year, state, D_pv2p, D_pv2p_lag1, D_pv2p_lag2) |>
  left_join(d_fred_2, by = "year") |>
  mutate(d_incumbent = case_when(year == "2016" ~ 1,
                                 year == "2020" ~ 0,
                                 year == "2024" ~ 1),
         d_incumbent_cand = case_when(year == "2016" ~ 0,
                                 year == "2020" ~ -1,
                                 year == "2024" ~ 0)) |>
  filter(year == 2024)|>
  left_join(nat_poll_d_yearly, by = "year")

nopoll_state_pred_2024 <- predict(d_nopoll_state_reg, d_nopoll_state_model_2024, interval = "prediction")

d_nopoll_state_model_2024 <- d_nopoll_state_model_2024 |>
  mutate(predicted_values = nopoll_state_pred_2024[, "fit"],
         lower_bounds = nopoll_state_pred_2024[, "lwr"],
         upper_bounds = nopoll_state_pred_2024[, "upr"])
states_map <- map_data("state")
d_nopoll_state_model_2024$region <- tolower(d_nopoll_state_model_2024$state)
```

```{r combined state pred map}
d_nopoll_state_model_2024 |>
  left_join(states_map, by = "region") |> 
  left_join(d_state_model_2024, by = "state") |>
  mutate(final_prediction = if_else(is.na(predicted_values.y) == 0, predicted_values.y, predicted_values.x),
         Margin = (final_prediction - 50) * 2) |>
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = Margin), color = "black") +
  scale_fill_gradient2(high = "dodgerblue4",
                       mid = "white",
                       low = "firebrick1",
                       breaks = c(-50, -25, 0, 25, 50),
                       limits = c(-50, 50)) +
  theme_void() +
  ggtitle("Predicted Presidential Vote by State for the 2024 Election") +
  labs(fill = "Harris Margin") +
  theme(aspect.ratio = .60)
```


## Introduction
- Overview (Nat model, state model(s), etc.)



## National Model and Prediction
### Equation and Variables

### Justification of Model

### Regression Table
- Include interpretation of coefficients

### Validation
- out of sample validation

### Final National Two-Party Vote Prediction



## State-Level Model and Predictions
### Equation and Variables
- Do for both state-level models

### Justrification of Model

### Regression Table
- Include interpretation of coefficients

### Validation
- Out of sample validation

### Final State-Level Two-Party Vote Prediction


## Conclusion


















```{r, include=FALSE}
## build_site(build_rmd=TRUE)
```




